<div class="week-view-container">
  <!-- No Projects Available Message -->
  <div *ngIf="availableProjects.length === 0" class="no-projects-message">
    <ion-card color="warning">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="alert-circle" slot="start"></ion-icon>
          No Projects Available
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <p>
          There are no active projects available for time tracking in this
          organization.
        </p>
        <p><strong>Next steps:</strong></p>
        <ul>
          <li>Contact an administrator to create projects</li>
          <li>Check if you have the correct permissions</li>
          <li>Verify the organization has active projects</li>
        </ul>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Regular Week View (only show if projects exist) -->
  <div *ngIf="availableProjects.length > 0">
    <div class="week-header">
      <h2>Week of {{ weekStart | date: "MMM d" }}</h2>
      <div class="header-actions">
        <ion-button
          *ngIf="!readonly"
          (click)="addRow()"
          fill="outline"
          size="small"
        >
          <ion-icon name="add" slot="start"></ion-icon>
          {{ "common.add_row" | translate }}
        </ion-button>

        <!-- Save Button -->
        <ion-button
          *ngIf="!readonly && hasUnsavedChanges"
          (click)="saveChanges()"
          color="primary"
          size="small"
          [disabled]="isLoading"
        >
          <ion-spinner
            *ngIf="isLoading"
            name="crescent"
            slot="start"
          ></ion-spinner>
          <ion-icon *ngIf="!isLoading" name="save" slot="start"></ion-icon>
          {{ isLoading ? "Saving..." : "Save Changes" }}
        </ion-button>
      </div>

      <!-- Status badges based on actual status -->
      <ion-badge
        *ngIf="status === 'approved'"
        color="success"
        class="status-badge"
      >
        <ion-icon name="checkmark-circle" slot="start"></ion-icon>
        {{ "common.approved_week" | translate }}
      </ion-badge>

      <ion-badge
        *ngIf="status === 'pending'"
        color="warning"
        class="status-badge"
      >
        <ion-icon name="time" slot="start"></ion-icon>
        {{ "common.pending_week" | translate }}
      </ion-badge>

      <ion-badge
        *ngIf="status === 'rejected'"
        color="danger"
        class="status-badge"
      >
        <ion-icon name="close-circle" slot="start"></ion-icon>
        {{ "common.rejected_week" | translate }}
      </ion-badge>

      <ion-badge *ngIf="status === 'mixed'" color="medium" class="status-badge">
        <ion-icon name="ellipsis-horizontal" slot="start"></ion-icon>
        {{ "common.mixed_status" | translate }}
      </ion-badge>
    </div>

    <!-- Desktop/Tablet View -->
    <div class="desktop-view">
      <table class="week-grid">
        <thead>
          <tr>
            <th class="project-column">
              {{ "time_tracking.project" | translate }}
            </th>
            <th *ngFor="let day of days" class="day-column">
              {{ day | date: "EEE MM/dd" }}
            </th>
            <th class="total-column">
              {{ "time_tracking.total" | translate }}
            </th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let row of rows; let i = index">
            <td class="project-cell">
              <!-- Show archived project name with indicator if it has time entries -->
              <div
                *ngIf="row.projectId && isProjectArchived(row.projectId)"
                class="archived-project-display"
              >
                <ion-icon
                  name="archive"
                  color="medium"
                  class="archived-icon"
                ></ion-icon>
                <span class="archived-project-name">{{
                  getProjectDetails(row.projectId)?.name || "Archived Project"
                }}</span>
                <ion-badge color="medium" size="small">Archived</ion-badge>
              </div>
              <!-- Regular project selection for active projects -->
              <ng-container
                *ngIf="!row.projectId || !isProjectArchived(row.projectId)"
              >
                <ion-select
                  [value]="row.projectId"
                  (ionChange)="addProjectById(i, $event)"
                  [disabled]="readonly"
                  [placeholder]="'common.select_project' | translate"
                  interface="popover"
                >
                  <ion-select-option value="" translate
                    >common.select</ion-select-option
                  >
                  <!-- Group projects by category -->
                  <ng-container *ngFor="let categoryKey of getCategoryKeys()">
                    <ion-select-option disabled class="category-header">
                      <div class="category-header-content">
                        <ion-icon
                          [name]="getCategoryInfo(categoryKey).icon"
                          [style.color]="getCategoryInfo(categoryKey).color"
                        ></ion-icon>
                        {{ getCategoryInfo(categoryKey).name }}
                      </div>
                    </ion-select-option>
                    <ion-select-option
                      *ngFor="let proj of groupedProjects[categoryKey]"
                      [value]="proj.id"
                      [disabled]="isSelected(proj.id, i)"
                      class="project-option"
                    >
                      {{ proj.name }}
                    </ion-select-option>
                  </ng-container>
                </ion-select>
              </ng-container>
              <ion-button
                *ngIf="!readonly"
                (click)="removeRow(i)"
                fill="clear"
                size="small"
                color="danger"
                class="remove-btn"
              >
                <ion-icon name="close" slot="icon-only"></ion-icon>
              </ion-button>
            </td>
            <td *ngFor="let day of days" class="hours-cell">
              <div
                class="hours-input-container"
                [class.has-pending-changes]="
                  row.projectId && hasPendingChange(row.projectId, day)
                "
              >
                <ion-input
                  type="number"
                  [value]="
                    row.projectId
                      ? hasPendingChange(row.projectId, day)
                        ? getPendingValue(row.projectId, day)
                        : getEntry(row.projectId, day)?.hours
                      : ''
                  "
                  (ionChange)="onHoursChange(i, day, $event)"
                  [disabled]="
                    !row.projectId ||
                    readonly ||
                    (row.projectId && isProjectArchived(row.projectId)) ||
                    isLoading
                  "
                  [readonly]="
                    readonly ||
                    (row.projectId && isProjectArchived(row.projectId))
                  "
                  placeholder="0"
                  min="0"
                  max="24"
                  step="0.25"
                  class="hours-input no-spinners"
                ></ion-input>
                <ion-button
                  *ngIf="row.projectId && !readonly"
                  fill="clear"
                  size="small"
                  (click)="openNotesModal(row.projectId!, day)"
                  class="notes-button"
                  [color]="
                    hasNotes(row.projectId!, day) ? 'primary' : undefined
                  "
                >
                  <ion-icon
                    [name]="
                      hasNotes(row.projectId!, day)
                        ? 'document-text'
                        : 'document-text-outline'
                    "
                    slot="icon-only"
                  ></ion-icon>
                </ion-button>
              </div>
            </td>
            <td class="total-cell">{{ rowTotals[i] || 0 }}</td>
          </tr>
        </tbody>
        <tfoot>
          <tr class="totals-row">
            <td class="project-cell">
              <strong>{{ "time_tracking.total" | translate }}</strong>
            </td>
            <td *ngFor="let total of columnTotals" class="total-cell">
              <strong>{{ total }}</strong>
            </td>
            <td class="total-cell">
              <strong>{{ totalHours }}</strong>
            </td>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- Mobile View -->
    <div class="mobile-view">
      <ion-card *ngFor="let row of rows; let i = index" class="project-card">
        <ion-card-header>
          <div class="project-header">
            <div class="project-selector">
              <!-- Show archived project name with indicator if it has time entries -->
              <div
                *ngIf="row.projectId && isProjectArchived(row.projectId)"
                class="archived-project-display"
              >
                <ion-icon
                  name="archive"
                  color="medium"
                  class="archived-icon"
                ></ion-icon>
                <span class="archived-project-name">{{
                  getProjectDetails(row.projectId)?.name || "Archived Project"
                }}</span>
                <ion-badge color="medium" size="small">Archived</ion-badge>
              </div>
              <!-- Regular project selection for active projects -->
              <ng-container
                *ngIf="!row.projectId || !isProjectArchived(row.projectId)"
              >
                <ion-select
                  [value]="row.projectId"
                  (ionChange)="addProjectById(i, $event)"
                  [disabled]="readonly"
                  [placeholder]="'common.select_project' | translate"
                  interface="popover"
                  fill="outline"
                >
                  <ion-select-option value="" translate
                    >common.select</ion-select-option
                  >
                  <!-- Group projects by category -->
                  <ng-container *ngFor="let categoryKey of getCategoryKeys()">
                    <ion-select-option disabled class="category-header">
                      <div class="category-header-content">
                        <ion-icon
                          [name]="getCategoryInfo(categoryKey).icon"
                          [style.color]="getCategoryInfo(categoryKey).color"
                        ></ion-icon>
                        {{ getCategoryInfo(categoryKey).name }}
                      </div>
                    </ion-select-option>
                    <ion-select-option
                      *ngFor="let proj of groupedProjects[categoryKey]"
                      [value]="proj.id"
                      [disabled]="isSelected(proj.id, i)"
                      class="project-option"
                    >
                      {{ proj.name }}
                    </ion-select-option>
                  </ng-container>
                </ion-select>
              </ng-container>
            </div>
            <ion-button
              *ngIf="!readonly"
              (click)="removeRow(i)"
              fill="clear"
              size="small"
              color="danger"
            >
              <ion-icon name="close" slot="icon-only"></ion-icon>
            </ion-button>
          </div>
          <div class="row-total">
            Total: <strong>{{ rowTotals[i] || 0 }} hours</strong>
          </div>
        </ion-card-header>

        <ion-card-content>
          <ion-grid class="hours-grid">
            <ion-row
              *ngFor="let day of days; let dayIndex = index"
              class="day-row"
            >
              <ion-col size="6">
                <ion-label>{{ day | date: "EEE MM/dd" }}</ion-label>
              </ion-col>
              <ion-col size="6">
                <div class="mobile-hours-input-container">
                  <ion-input
                    type="number"
                    [value]="
                      row.projectId ? getEntry(row.projectId, day)?.hours : ''
                    "
                    (ionChange)="onHoursChange(i, day, $event)"
                    [disabled]="
                      !row.projectId ||
                      readonly ||
                      (row.projectId && isProjectArchived(row.projectId))
                    "
                    [readonly]="
                      readonly ||
                      (row.projectId && isProjectArchived(row.projectId))
                    "
                    placeholder="0"
                    min="0"
                    max="24"
                    step="0.25"
                    fill="outline"
                    class="mobile-hours-input no-spinners"
                  ></ion-input>
                  <ion-button
                    *ngIf="row.projectId"
                    (click)="openNotesModal(row.projectId, day)"
                    fill="clear"
                    size="small"
                    class="notes-button"
                    [disabled]="readonly"
                    [color]="
                      hasNotes(row.projectId, day) ? 'primary' : undefined
                    "
                  >
                    <ion-icon
                      [name]="
                        hasNotes(row.projectId, day)
                          ? 'document-text'
                          : 'document-text-outline'
                      "
                    ></ion-icon>
                  </ion-button>
                </div>
              </ion-col>
            </ion-row>
          </ion-grid>
        </ion-card-content>
      </ion-card>

      <!-- Mobile Totals Card -->
      <ion-card class="totals-card">
        <ion-card-header>
          <ion-card-title>{{
            "time_tracking.daily_totals" | translate
          }}</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-grid>
            <ion-row
              *ngFor="let day of days; let dayIndex = index"
              class="total-row"
            >
              <ion-col size="6">
                <ion-label>{{ day | date: "EEE MM/dd" }}</ion-label>
              </ion-col>
              <ion-col size="6">
                <strong>{{ columnTotals[dayIndex] || 0 }} hours</strong>
              </ion-col>
            </ion-row>
            <ion-row class="grand-total">
              <ion-col size="6">
                <ion-label
                  ><strong>{{
                    "time_tracking.week_total" | translate
                  }}</strong></ion-label
                >
              </ion-col>
              <ion-col size="6">
                <strong>{{ totalHours }} hours</strong>
              </ion-col>
            </ion-row>
          </ion-grid>
        </ion-card-content>
      </ion-card>
    </div>
  </div>
  <!-- End conditional projects check -->
</div>
