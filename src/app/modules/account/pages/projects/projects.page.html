<ion-header>
  <ion-toolbar>
    <ion-title>Projects</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- Loading State -->
  <ion-loading
    *ngIf="loading$ | async"
    message="Loading projects..."
  ></ion-loading>

  <!-- Error State -->
  <ion-item *ngIf="error$ | async as error" class="error-item">
    <ion-icon name="alert-circle" slot="start" color="danger"></ion-icon>
    <ion-label>
      <h3>Error</h3>
      <p>{{ error }}</p>
    </ion-label>
  </ion-item>

  <!-- Add New Project -->
  <ion-card *ngIf="(isGroupAdmin$ | async)" class="add-project-card">
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="add-circle" class="title-icon"></ion-icon>
        Add New Project
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <app-category-selector
        [selectedCategory]="selectedCategory"
        (categoryChange)="onCategorySelected($event)"
        placeholder="Choose a category for your project"
      ></app-category-selector>

      <!-- Project Name Input (always shown first for smart suggestions) -->
      <ion-item lines="none" class="project-name-input">
        <ion-label position="stacked">Project Name</ion-label>
        <ion-input
          placeholder="Enter your project name here (suggestions will appear)"
          [(ngModel)]="newProjectName"
          (ionInput)="onProjectNameChange($event.detail.value)"
          (keyup.enter)="addProject()"
          clearInput="true"
        ></ion-input>
      </ion-item>

      <!-- Smart Category Suggestions -->
      <app-smart-category-suggestions
        [suggestions]="suggestedCategories"
        [visible]="showCategorySuggestions"
        (categorySelected)="onCategorySelected($event)"
        (dismissed)="dismissCategorySuggestions()"
      ></app-smart-category-suggestions>

      <!-- Template Selection (shown after category is selected) -->
      <div
        *ngIf="selectedCategory && availableTemplates.length > 0"
        class="template-selection"
      >
        <ion-label>
          <h4>Choose Template (Optional)</h4>
          <p>
            Select a template to pre-populate your project with common settings
          </p>
        </ion-label>

        <ion-radio-group [(ngModel)]="selectedTemplate">
          <div class="templates-grid">
            <ion-item
              *ngFor="let template of availableTemplates"
              class="template-option"
              lines="none"
            >
              <ion-radio
                slot="start"
                [value]="template"
                (ionSelect)="onTemplateSelected(template)"
              ></ion-radio>

              <ion-label class="template-info">
                <h3>{{ template.name }}</h3>
                <p>{{ template.description }}</p>
                <div class="template-meta">
                  <ion-chip color="light" size="small"
                    >{{ template.complexity }}</ion-chip
                  >
                  <ion-chip color="light" size="small"
                    >{{ template.estimatedTimeframe }}</ion-chip
                  >
                </div>
              </ion-label>
            </ion-item>
          </div>
        </ion-radio-group>
      </div>

      <!-- Action Buttons -->
      <div class="add-project-actions" *ngIf="selectedCategory">
        <ion-button
          fill="clear"
          size="small"
          (click)="resetProjectCreation()"
          class="cancel-button"
        >
          Clear
        </ion-button>

        <!-- Advanced Options Toggle -->
        <ion-button
          fill="outline"
          size="small"
          (click)="toggleBulkCreate()"
          class="bulk-toggle-button"
        >
          <ion-icon
            [name]="bulkCreateProjects ? 'remove' : 'copy'"
            slot="start"
          ></ion-icon>
          {{ bulkCreateProjects ? 'Single Project' : 'Multiple Projects' }}
        </ion-button>

        <ion-button
          fill="solid"
          size="small"
          (click)="bulkCreateProjects ? createBulkProjects() : addProject()"
          [disabled]="!newProjectName.trim()"
          class="create-button"
        >
          <ion-icon name="add" slot="start"></ion-icon>
          {{ bulkCreateProjects ? 'Create ' + bulkCreateNames.length + '
          Projects' : 'Create Project' }}
        </ion-button>
      </div>

      <!-- Bulk Creation Interface -->
      <div
        *ngIf="selectedCategory && bulkCreateProjects"
        class="bulk-create-section"
      >
        <ion-label>
          <h4>Multiple Project Creation</h4>
          <p>
            Create multiple projects at once with the same category and template
          </p>
        </ion-label>

        <div class="bulk-projects-list">
          <ion-item
            *ngFor="let name of bulkCreateNames; let i = index"
            lines="none"
            class="bulk-project-item"
          >
            <ion-label position="stacked">Project {{ i + 1 }} Name</ion-label>
            <ion-input
              [(ngModel)]="bulkCreateNames[i]"
              placeholder="Enter project name"
              clearInput="true"
            ></ion-input>
            <ion-button
              *ngIf="bulkCreateNames.length > 1"
              fill="clear"
              size="small"
              slot="end"
              (click)="removeBulkCreateProject(i)"
            >
              <ion-icon name="trash" color="danger"></ion-icon>
            </ion-button>
          </ion-item>
        </div>

        <ion-button
          fill="outline"
          size="small"
          (click)="addBulkCreateProject()"
          class="add-bulk-project-btn"
        >
          <ion-icon name="add" slot="start"></ion-icon>
          Add Another Project
        </ion-button>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Search and Filter Controls -->
  <app-project-filters
    *ngIf="!(loading$ | async)"
    [currentFilter]="currentProjectFilter"
    (filterChange)="onProjectFilterChange($event)"
  ></app-project-filters>

  <!-- Bulk Actions Component -->
  <app-bulk-actions
    [selectedProjects]="selectedProjects"
    [showBulkActions]="showBulkActions"
    (bulkAction)="onBulkAction($event)"
  ></app-bulk-actions>

  <!-- Category Overview Cards -->
  <div
    *ngIf="showCategoryOverview && (categoryOverview$ | async) as overview"
    class="category-overview"
  >
    <div class="category-grid">
      <div
        *ngFor="let categoryKey of templateCategories"
        class="category-card"
        (click)="selectCategoryFilter(categoryKey)"
      >
        <div class="category-header">
          <ion-icon
            [name]="projectCategories[categoryKey].icon"
            [style.color]="projectCategories[categoryKey].color"
          ></ion-icon>
          <h3>{{ categoryKey }}</h3>
        </div>
        <div class="category-stats">
          <p class="project-count">
            {{ (overview[categoryKey].count || 0) }} projects
          </p>
          <p class="hours-count" *ngIf="overview[categoryKey].hours">
            {{ (overview[categoryKey].hours || 0) }} hours logged
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Active Projects Section -->
  <ion-card *ngIf="!(loading$ | async)" class="projects-section">
    <ion-card-header class="section-header">
      <ion-card-title>
        <ion-icon name="folder-open" class="title-icon"></ion-icon>
        Active Projects
        <ion-badge color="primary" class="count-badge">
          {{ (filteredProjects$ | async)?.length || 0 }}
        </ion-badge>
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <!-- No Projects Message -->
      <div
        *ngIf="(filteredProjects$ | async)?.length === 0"
        class="no-projects-message"
      >
        <ion-icon
          name="folder-open-outline"
          class="no-projects-icon"
        ></ion-icon>
        <h3>No Projects Found</h3>
        <p *ngIf="searchTerm || selectedCategoryFilter !== 'all'">
          Try adjusting your search or filter criteria.
        </p>
        <p *ngIf="!searchTerm && selectedCategoryFilter === 'all'">
          Create your first project to get started!
        </p>
      </div>

      <!-- Grouped View -->
      <div *ngIf="groupByCategory && (groupedProjects$ | async) as grouped">
        <div
          *ngFor="let categoryKey of templateCategories"
          class="category-group"
        >
          <ion-item-divider
            *ngIf="grouped[categoryKey] && grouped[categoryKey].length > 0"
            class="category-divider"
          >
            <ion-icon
              [name]="projectCategories[categoryKey].icon"
              slot="start"
              [style.color]="projectCategories[categoryKey].color"
            ></ion-icon>
            <ion-label>
              <h2>{{ categoryKey }}</h2>
              <p>{{ grouped[categoryKey].length }} project(s)</p>
            </ion-label>
          </ion-item-divider>

          <ion-list lines="none">
            <ion-item
              *ngFor="let proj of grouped[categoryKey]; trackBy: trackById"
              class="project-item active-project"
              [class.selected]="selectedProjects.has(proj.id)"
            >
              <!-- Selection Checkbox -->
              <ion-checkbox
                *ngIf="(isGroupAdmin$ | async)"
                slot="start"
                [checked]="selectedProjects.has(proj.id)"
                (ionChange)="toggleProjectSelection(proj.id)"
                class="project-checkbox"
              ></ion-checkbox>

              <ion-icon
                *ngIf="!(isGroupAdmin$ | async)"
                name="radio-button-on"
                slot="start"
                color="success"
              ></ion-icon>

              <div class="project-content">
                <ng-container
                  *ngIf="(isGroupAdmin$ | async); else viewProjectGrouped"
                >
                  <ion-input
                    [value]="proj.name"
                    (ionChange)="updateProject(proj, $event.detail.value)"
                    class="project-name-input"
                  ></ion-input>
                </ng-container>

                <ng-template #viewProjectGrouped>
                  <div class="project-details">
                    <ion-label class="project-name">{{ proj.name }}</ion-label>
                    <ion-chip
                      *ngIf="proj.standardCategory && projectCategories[proj.standardCategory]"
                      [style.background-color]="projectCategories[proj.standardCategory].color"
                      class="project-category-badge"
                    >
                      <ion-icon
                        [name]="projectCategories[proj.standardCategory].icon"
                        class="category-icon"
                      ></ion-icon>
                      <ion-label>{{ proj.standardCategory }}</ion-label>
                    </ion-chip>
                  </div>
                </ng-template>
              </div>

              <div
                slot="end"
                class="project-actions"
                *ngIf="(isGroupAdmin$ | async)"
              >
                <ion-button
                  fill="clear"
                  size="small"
                  (click)="toggleArchive(proj, true)"
                  color="warning"
                >
                  <ion-icon name="archive" slot="icon-only"></ion-icon>
                </ion-button>
              </div>
            </ion-item>
          </ion-list>
        </div>
      </div>

      <!-- Normal List View -->
      <ion-list
        *ngIf="!groupByCategory && (filteredProjects$ | async) && (filteredProjects$ | async)!.length > 0"
        lines="none"
      >
        <ion-item
          *ngFor="let proj of (filteredProjects$ | async); trackBy: trackById"
          class="project-item active-project"
          [class.selected]="selectedProjects.has(proj.id)"
        >
          <!-- Selection Checkbox -->
          <ion-checkbox
            *ngIf="(isGroupAdmin$ | async)"
            slot="start"
            [checked]="selectedProjects.has(proj.id)"
            (ionChange)="toggleProjectSelection(proj.id)"
            class="project-checkbox"
          ></ion-checkbox>

          <ion-icon
            *ngIf="!(isGroupAdmin$ | async)"
            name="radio-button-on"
            slot="start"
            color="success"
          ></ion-icon>

          <div class="project-content">
            <ng-container *ngIf="(isGroupAdmin$ | async); else viewProject">
              <ion-input
                [value]="proj.name"
                (ionChange)="updateProject(proj, $event.detail.value)"
                class="project-name-input"
              ></ion-input>
            </ng-container>

            <ng-template #viewProject>
              <div class="project-details">
                <ion-label class="project-name">{{ proj.name }}</ion-label>
                <ion-chip
                  *ngIf="proj.standardCategory && projectCategories[proj.standardCategory]"
                  [style.background-color]="projectCategories[proj.standardCategory].color"
                  class="project-category-badge"
                >
                  <ion-icon
                    [name]="projectCategories[proj.standardCategory].icon"
                    class="category-icon"
                  ></ion-icon>
                  <ion-label>{{ proj.standardCategory }}</ion-label>
                </ion-chip>
              </div>
            </ng-template>
          </div>

          <div
            slot="end"
            class="project-actions"
            *ngIf="(isGroupAdmin$ | async)"
          >
            <ion-button
              fill="clear"
              size="small"
              (click)="toggleArchive(proj, true)"
              color="warning"
            >
              <ion-icon name="archive" slot="icon-only"></ion-icon>
            </ion-button>
          </div>
        </ion-item>
      </ion-list>
    </ion-card-content>
  </ion-card>

  <!-- Archived Projects Section -->
  <div
    *ngIf="(archivedProjects$ | async) && (archivedProjects$ | async)!.length > 0"
    class="archived-section"
  >
    <ion-card class="archived-projects-card">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="archive" class="title-icon"></ion-icon>
          Archived Projects
          <ion-badge color="medium" class="count-badge">
            {{ (archivedProjects$ | async)?.length }}
          </ion-badge>
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list lines="none">
          <ion-item
            *ngFor="let proj of (archivedProjects$ | async); trackBy: trackById"
            class="project-item archived-project"
          >
            <ion-icon name="archive" slot="start" color="medium"></ion-icon>

            <div class="project-content">
              <ion-label class="project-name">
                {{ proj.name }}
                <ion-badge color="medium" class="archived-badge"
                  >Archived</ion-badge
                >
              </ion-label>
            </div>

            <div
              slot="end"
              class="project-actions"
              *ngIf="(isGroupAdmin$ | async)"
            >
              <ion-button
                fill="clear"
                size="small"
                (click)="toggleArchive(proj, false)"
                color="primary"
              >
                <ion-icon name="arrow-undo" slot="icon-only"></ion-icon>
              </ion-button>
            </div>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>
  </div>
</ion-content>
