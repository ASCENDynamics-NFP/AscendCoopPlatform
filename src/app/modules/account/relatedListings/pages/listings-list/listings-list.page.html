<!--
Nonprofit Social Networking Platform: Allowing Users and Organizations to Collaborate.
Copyright (C) 2023  ASCENDynamics NFP

This file is part of Nonprofit Social Networking Platform.

Nonprofit Social Networking Platform is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published
by the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

Nonprofit Social Networking Platform is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with Nonprofit Social Networking Platform.  If not, see <https://www.gnu.org/licenses/>.
-->
<!-- src/app/pages/account/relatedListings/pages/listings-list.page.html -->

<ion-header>
  <app-header
    [title]="title"
    [defaultHref]="'account/'+ accountId"
  ></app-header>
  <ion-toolbar>
    <ion-segment
      scrollable
      [(ngModel)]="relationshipFilter"
      (ionChange)="onRelationshipFilterChange($event)"
    >
      <ion-segment-button value="all">
        <ion-icon name="list-outline"></ion-icon>
        <ion-label>All</ion-label>
      </ion-segment-button>
      <ion-segment-button value="owner">
        <ion-icon name="person-outline"></ion-icon>
        <ion-label>Posted Listings</ion-label>
      </ion-segment-button>
      <ion-segment-button
        value="applicant"
        *ngIf="(isOwner$ | async) || (isGroupAdmin$ | async)"
      >
        <ion-icon name="paper-plane-outline"></ion-icon>
        <ion-label>Applications</ion-label>
      </ion-segment-button>
      <ion-segment-button value="participant">
        <ion-icon name="people-outline"></ion-icon>
        <ion-label>Participating</ion-label>
      </ion-segment-button>
      <ion-segment-button value="saved">
        <ion-icon name="bookmark-outline"></ion-icon>
        <ion-label>Saved</ion-label>
      </ion-segment-button>
      <ion-segment-button
        value="archived"
        *ngIf="(isOwner$ | async) || (isGroupAdmin$ | async)"
      >
        <ion-icon name="archive-outline"></ion-icon>
        <ion-label>Archived</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
  <ion-toolbar>
    <ion-segment
      scrollable
      [(ngModel)]="typeFilter"
      (ionChange)="onTypeFilterChange($event)"
    >
      <ion-segment-button value="all">
        <ion-icon name="apps-outline"></ion-icon>
        <ion-label>All Types</ion-label>
      </ion-segment-button>
      <ion-segment-button value="volunteer">
        <ion-icon name="heart-outline"></ion-icon>
        <ion-label>Volunteer</ion-label>
      </ion-segment-button>
      <ion-segment-button value="job">
        <ion-icon name="briefcase-outline"></ion-icon>
        <ion-label>Jobs</ion-label>
      </ion-segment-button>
      <ion-segment-button value="internship">
        <ion-icon name="school-outline"></ion-icon>
        <ion-label>Internships</ion-label>
      </ion-segment-button>
      <ion-segment-button value="gig">
        <ion-icon name="flash-outline"></ion-icon>
        <ion-label>Gigs</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ion-list *ngIf="(paginatedListings$ | async)?.length; else emptyState">
    <ion-item
      *ngFor="let listing of (paginatedListings$ | async); trackBy: trackById"
      (click)="goToListing(listing.id)"
      button
    >
      <ion-thumbnail slot="start">
        <img
          *ngIf="listing.iconImage"
          [src]="listing.iconImage"
          [alt]="listing.title"
        />
        <div *ngIf="!listing.iconImage" class="placeholder-thumbnail"></div>
      </ion-thumbnail>
      <ion-label>
        <h2>{{ listing.title }}</h2>
        <h3>{{ listing.organization }}</h3>
        <div class="ion-padding-vertical">
          <ion-badge color="primary" class="ion-margin-end"
            >{{ listing.type | titlecase }}</ion-badge
          >
          <ion-badge
            [color]="getStatusColor(listing.status)"
            class="ion-margin-end"
          >
            {{ listing.status | titlecase }}
          </ion-badge>
          <ion-badge color="tertiary"
            >{{ listing.relationship | titlecase }}</ion-badge
          >
        </div>
      </ion-label>

      <!-- Action buttons for different relationships and permissions -->
      <div class="listing-actions" slot="end">
        <!-- Primary action buttons (always visible) -->
        <div class="primary-actions">
          <!-- Save/Unsave button for non-owner listings -->
          <ion-button
            *ngIf="listing.relationship !== 'owner' && listing.relationship !== 'saved'"
            fill="clear"
            size="small"
            color="medium"
            (click)="saveListing(listing); $event.stopPropagation()"
          >
            <ion-icon name="bookmark-outline" slot="icon-only"></ion-icon>
          </ion-button>

          <!-- Unsave button for saved listings -->
          <ion-button
            *ngIf="listing.relationship === 'saved'"
            fill="clear"
            size="small"
            color="warning"
            (click)="unsaveListing(listing); $event.stopPropagation()"
          >
            <ion-icon name="bookmark" slot="icon-only"></ion-icon>
          </ion-button>

          <!-- Primary action for owners -->
          <ion-button
            *ngIf="listing.relationship === 'owner' && listing.status === 'active'"
            fill="clear"
            size="small"
            color="primary"
            [routerLink]="['/listings', listing.id, 'applicants']"
            (click)="$event.stopPropagation()"
          >
            <ion-icon name="people-outline" slot="icon-only"></ion-icon>
          </ion-button>

          <!-- Remove application button for non-owner relationships -->
          <ion-button
            *ngIf="listing.relationship === 'applicant' || listing.relationship === 'participant'"
            fill="clear"
            size="small"
            color="danger"
            (click)="removeRelatedListing(listing); $event.stopPropagation()"
          >
            <ion-icon name="close-circle-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </div>

        <!-- More actions button (for additional actions) -->
        <ion-button
          *ngIf="(isOwner$ | async) || (isGroupAdmin$ | async)"
          fill="clear"
          size="small"
          color="medium"
          id="trigger-{{ listing.id }}"
          (click)="$event.stopPropagation()"
        >
          <ion-icon name="ellipsis-vertical" slot="icon-only"></ion-icon>
        </ion-button>

        <!-- Popover for additional actions -->
        <ion-popover
          [trigger]="'trigger-' + listing.id"
          trigger-action="click"
          side="left"
          alignment="end"
        >
          <ng-template>
            <ion-content class="action-popover">
              <ion-list>
                <!-- Edit button for owner listings -->
                <ion-item
                  *ngIf="listing.relationship === 'owner'"
                  button
                  (click)="navigateAndClosePopover('/listings/' + listing.id + '/edit')"
                >
                  <ion-icon name="create-outline" slot="start"></ion-icon>
                  <ion-label>Edit</ion-label>
                </ion-item>

                <!-- Archive/Unarchive button for owner listings -->
                <ion-item
                  *ngIf="listing.relationship === 'owner' && listing.status === 'active'"
                  button
                  (click)="archiveListing(listing); closePopover('trigger-' + listing.id)"
                >
                  <ion-icon name="archive-outline" slot="start"></ion-icon>
                  <ion-label>Archive</ion-label>
                </ion-item>

                <ion-item
                  *ngIf="listing.relationship === 'owner' && (listing.status === 'filled' || listing.status === 'expired')"
                  button
                  (click)="unarchiveListing(listing); closePopover('trigger-' + listing.id)"
                >
                  <ion-icon name="refresh-outline" slot="start"></ion-icon>
                  <ion-label>Reactivate</ion-label>
                </ion-item>

                <!-- Mark as Filled -->
                <ion-item
                  *ngIf="listing.relationship === 'owner' && listing.status === 'active'"
                  button
                  (click)="markAsFilled(listing); closePopover('trigger-' + listing.id)"
                >
                  <ion-icon
                    name="checkmark-circle-outline"
                    slot="start"
                  ></ion-icon>
                  <ion-label>Mark as Filled</ion-label>
                </ion-item>

                <!-- Duplicate listing -->
                <ion-item
                  *ngIf="listing.relationship === 'owner'"
                  button
                  (click)="duplicateListing(listing); closePopover('trigger-' + listing.id)"
                >
                  <ion-icon name="copy-outline" slot="start"></ion-icon>
                  <ion-label>Duplicate</ion-label>
                </ion-item>

                <!-- Delete button for owner listings -->
                <ion-item
                  *ngIf="listing.relationship === 'owner'"
                  button
                  (click)="deleteListing(listing); closePopover('trigger-' + listing.id)"
                  color="danger"
                >
                  <ion-icon name="trash-outline" slot="start"></ion-icon>
                  <ion-label>Delete</ion-label>
                </ion-item>
              </ion-list>
            </ion-content>
          </ng-template>
        </ion-popover>
      </div>
    </ion-item>
  </ion-list>

  <!-- Empty state -->
  <ng-template #emptyState>
    <div class="empty-state ion-text-center ion-padding">
      <ion-icon
        name="document-text-outline"
        size="large"
        color="medium"
      ></ion-icon>
      <h3>No listings found</h3>
      <p *ngIf="relationshipFilter === 'owner'" color="medium">
        You haven't posted any listings yet.
      </p>
      <p *ngIf="relationshipFilter === 'saved'" color="medium">
        You haven't saved any listings yet.
      </p>
      <p *ngIf="relationshipFilter === 'participant'" color="medium">
        You're not participating in any listings yet.
      </p>
      <p *ngIf="relationshipFilter === 'applicant'" color="medium">
        No applications found.
      </p>
      <p *ngIf="relationshipFilter === 'archived'" color="medium">
        No archived listings found.
      </p>
      <p *ngIf="relationshipFilter === 'all'" color="medium">
        No listings available.
      </p>

      <!-- Add listing button for owners -->
      <ion-button
        *ngIf="relationshipFilter === 'owner' && (isOwner$ | async)"
        routerLink="/listings/create"
        fill="clear"
        color="primary"
      >
        <ion-icon name="add" slot="start"></ion-icon>
        Create Your First Listing
      </ion-button>

      <!-- Browse listings button for other cases -->
      <ion-button
        *ngIf="relationshipFilter !== 'owner'"
        routerLink="/listings"
        fill="clear"
        color="primary"
      >
        <ion-icon name="search" slot="start"></ion-icon>
        Browse Available Listings
      </ion-button>
    </div>
  </ng-template>

  <ion-fab
    vertical="bottom"
    horizontal="end"
    slot="fixed"
    *ngIf="currentUser$ | async"
  >
    <ion-fab-button *ngIf="(isOwner$ | async)" routerLink="/listings/create">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>

  <app-pagination
    [totalItems]="(filteredRelatedListings$ | async)?.length || 0"
    [pageSize]="pageSize"
    [maxVisiblePages]="5"
    (pageChange)="goToPage($event)"
  ></app-pagination>
</ion-content>
