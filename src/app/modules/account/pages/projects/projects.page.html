<ion-header>
  <ion-toolbar>
    <ion-title>Projects</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- Loading State -->
  <ion-loading
    *ngIf="loading$ | async"
    message="Loading projects..."
  ></ion-loading>

  <!-- Error State -->
  <ion-item *ngIf="error$ | async as error" class="error-item">
    <ion-icon name="alert-circle" slot="start" color="danger"></ion-icon>
    <ion-label>
      <h3>Error</h3>
      <p>{{ error }}</p>
    </ion-label>
  </ion-item>

  <!-- Create New Project Toggle -->
  <div *ngIf="(isGroupAdmin$ | async)" class="create-project-section">
    <!-- Toggle Button -->
    <div class="create-project-toggle" *ngIf="!showProjectCreation">
      <ion-button
        fill="outline"
        color="primary"
        (click)="toggleProjectCreation()"
        class="create-toggle-btn"
      >
        <ion-icon name="add" slot="start"></ion-icon>
        Create New Project
      </ion-button>
    </div>

    <!-- Project Creation Form (Collapsed by default) -->
    <ion-card *ngIf="showProjectCreation" class="creation-form-card">
      <ion-card-header>
        <ion-card-title class="creation-form-title">
          <span>Create New Project</span>
          <ion-button
            fill="clear"
            color="medium"
            (click)="closeProjectCreation()"
            class="close-btn"
          >
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-card-title>
      </ion-card-header>

      <ion-card-content>
        <app-project-creation
          [state]="projectCreationState"
          (projectCreate)="onProjectCreate($event)"
          (categoryChange)="onCategorySelectedFromComponent($event)"
          (projectNameChange)="onProjectNameChangeFromComponent($event)"
          (templateSelected)="onTemplateSelectedFromComponent($event)"
          (stateChange)="onProjectCreationStateChange($event)"
        ></app-project-creation>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Search and Filter Controls -->
  <app-project-filters
    *ngIf="!(loading$ | async)"
    [searchTerm]="currentProjectFilter.searchTerm"
    [selectedCategory]="currentProjectFilter.selectedCategory"
    [sortBy]="currentProjectFilter.sortBy"
    [sortDirection]="currentProjectFilter.sortDirection"
    [groupByCategory]="currentProjectFilter.showGrouped"
    [projectCount]="(filteredProjects$ | async)?.length || 0"
    [showCategoryOverview]="showCategoryOverview"
    (filterChange)="onProjectFilterChange($event)"
    (toggleCategoryOverview)="toggleCategoryOverview()"
  ></app-project-filters>

  <!-- Bulk Actions Component -->
  <app-bulk-actions
    [selectedProjects]="selectedProjects"
    [showBulkActions]="true"
    (bulkAction)="onBulkAction($event)"
  ></app-bulk-actions>

  <!-- Category Overview Analytics Dashboard -->
  <div
    *ngIf="showCategoryOverview && (categoryOverview$ | async) as overview"
    class="analytics-dashboard"
  >
    <!-- Dashboard Header -->
    <div class="dashboard-header">
      <div class="header-content">
        <ion-icon name="analytics-outline" class="dashboard-icon"></ion-icon>
        <div class="header-text">
          <h2>Project Analytics</h2>
          <p>Overview of your projects by category</p>
        </div>
      </div>
      <div class="total-stats">
        <div class="total-stat">
          <span class="stat-number">{{ getTotalProjects(overview) }}</span>
          <span class="stat-label">Total Projects</span>
        </div>
        <div class="total-stat">
          <span class="stat-number">{{ getActiveCategories(overview) }}</span>
          <span class="stat-label">Active Categories</span>
        </div>
      </div>
    </div>

    <!-- Analytics Grid -->
    <div class="analytics-grid">
      <!-- Main Chart/Stats Card -->
      <div class="main-analytics-card">
        <div class="card-header">
          <h3>Category Distribution</h3>
          <ion-badge color="medium"
            >{{ getTotalProjects(overview) }} total</ion-badge
          >
        </div>
        <div class="chart-container">
          <!-- Donut Chart Representation -->
          <div class="donut-chart">
            <div class="donut-inner">
              <span class="donut-total">{{ getTotalProjects(overview) }}</span>
              <span class="donut-label">Projects</span>
            </div>
          </div>
          <!-- Legend -->
          <div class="chart-legend">
            <div
              *ngFor="let categoryKey of getTopCategories(overview)"
              class="legend-item"
              (click)="selectCategoryFilter(categoryKey)"
            >
              <div
                class="legend-color"
                [style.background-color]="getCategoryInfo(categoryKey).color || '#6c757d'"
              ></div>
              <span class="legend-label">{{ categoryKey }}</span>
              <span class="legend-value"
                >{{ overview[categoryKey].count || 0 }}</span
              >
            </div>
          </div>
        </div>
      </div>

      <!-- Category Cards Grid -->
      <div class="category-cards-grid">
        <div
          *ngFor="let categoryKey of templateCategories"
          class="analytics-category-card"
          [class.has-projects]="(overview[categoryKey].count || 0) > 0"
          (click)="selectCategoryFilter(categoryKey)"
        >
          <div class="card-header">
            <div class="category-icon-wrapper">
              <ion-icon
                [name]="getCategoryInfo(categoryKey).icon || 'folder-outline'"
                [style.color]="getCategoryInfo(categoryKey).color || '#6c757d'"
                class="category-icon"
              ></ion-icon>
            </div>
            <h4>{{ categoryKey }}</h4>
          </div>

          <div class="card-stats">
            <div class="primary-stat">
              <span class="stat-number"
                >{{ overview[categoryKey].count || 0 }}</span
              >
              <span class="stat-label">Projects</span>
            </div>

            <div class="secondary-stats">
              <div class="secondary-stat">
                <ion-icon name="time-outline"></ion-icon>
                <span>{{ overview[categoryKey].hours || 0 }}h</span>
              </div>
              <div class="secondary-stat">
                <ion-icon name="trending-up-outline"></ion-icon>
                <span>{{ getProjectPercentage(overview, categoryKey) }}%</span>
              </div>
            </div>
          </div>

          <div class="card-progress">
            <div
              class="progress-bar"
              [style.width.%]="getProjectPercentage(overview, categoryKey)"
              [style.background-color]="getCategoryInfo(categoryKey).color || '#6c757d'"
            ></div>
          </div>
        </div>
      </div>

      <!-- Quick Actions Card -->
      <!-- <div class="quick-actions-card">
        <div class="card-header">
          <h3>Quick Actions</h3>
          <ion-icon name="flash-outline"></ion-icon>
        </div>
        <div class="actions-grid">
          <button class="action-button" (click)="openProjectCreation()">
            <ion-icon name="add-circle-outline"></ion-icon>
            <span>New Project</span>
          </button>
          <button class="action-button" (click)="selectCategoryFilter('all')">
            <ion-icon name="list-outline"></ion-icon>
            <span>View All</span>
          </button>
          <button class="action-button" (click)="toggleGroupByCategory()">
            <ion-icon name="grid-outline"></ion-icon>
            <span>Group View</span>
          </button>
          <button class="action-button" (click)="exportAnalytics()">
            <ion-icon name="download-outline"></ion-icon>
            <span>Export</span>
          </button>
        </div>
      </div> -->
    </div>
  </div>

  <!-- Active Projects Section -->
  <ion-card *ngIf="!(loading$ | async)" class="projects-section">
    <ion-card-header class="section-header">
      <ion-card-title>
        <ion-icon name="folder-open" class="title-icon"></ion-icon>
        Active Projects
        <ion-badge color="primary" class="count-badge">
          {{ (filteredProjects$ | async)?.length || 0 }}
        </ion-badge>
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <!-- No Projects Message -->
      <div
        *ngIf="(filteredProjects$ | async)?.length === 0"
        class="no-projects-message"
      >
        <ion-icon
          name="folder-open-outline"
          class="no-projects-icon"
        ></ion-icon>
        <h3>No Projects Found</h3>
        <p *ngIf="searchTerm || selectedCategoryFilter !== 'all'">
          Try adjusting your search or filter criteria.
        </p>
        <p *ngIf="!searchTerm && selectedCategoryFilter === 'all'">
          Create your first project to get started!
        </p>
      </div>

      <!-- Grouped View -->
      <div *ngIf="groupByCategory && (groupedProjects$ | async) as grouped">
        <div
          *ngFor="let categoryKey of templateCategories"
          class="category-group"
        >
          <ion-item-divider
            *ngIf="grouped[categoryKey] && grouped[categoryKey].length > 0"
            class="category-divider"
          >
            <ion-icon
              [name]="projectCategories[categoryKey].icon"
              slot="start"
              [style.color]="projectCategories[categoryKey].color"
            ></ion-icon>
            <ion-label>
              <h2>{{ categoryKey }}</h2>
              <p>{{ grouped[categoryKey].length }} project(s)</p>
            </ion-label>
          </ion-item-divider>

          <ion-list lines="none">
            <ion-item
              *ngFor="let proj of grouped[categoryKey]; trackBy: trackById"
              class="project-item active-project"
              [class.selected]="selectedProjects.has(proj.id)"
            >
              <!-- Selection Checkbox -->
              <ion-checkbox
                *ngIf="(isGroupAdmin$ | async)"
                slot="start"
                [checked]="selectedProjects.has(proj.id)"
                (ionChange)="toggleProjectSelection(proj.id)"
                class="project-checkbox"
              ></ion-checkbox>

              <ion-icon
                *ngIf="!(isGroupAdmin$ | async)"
                name="radio-button-on"
                slot="start"
                color="success"
              ></ion-icon>

              <div class="project-content">
                <ng-container
                  *ngIf="(isGroupAdmin$ | async); else viewProjectGrouped"
                >
                  <ion-input
                    [value]="proj.name"
                    (ionChange)="updateProject(proj, $event.detail.value)"
                    class="project-name-input"
                  ></ion-input>
                </ng-container>

                <ng-template #viewProjectGrouped>
                  <div class="project-details">
                    <ion-label class="project-name">{{ proj.name }}</ion-label>
                    <ion-chip
                      *ngIf="proj.standardCategory && projectCategories[proj.standardCategory]"
                      [style.background-color]="projectCategories[proj.standardCategory].color"
                      class="project-category-badge"
                    >
                      <ion-icon
                        [name]="projectCategories[proj.standardCategory].icon"
                        class="category-icon"
                      ></ion-icon>
                      <ion-label>{{ proj.standardCategory }}</ion-label>
                    </ion-chip>
                  </div>
                </ng-template>
              </div>

              <div
                slot="end"
                class="project-actions"
                *ngIf="(isGroupAdmin$ | async)"
              >
                <ion-button
                  fill="clear"
                  size="small"
                  (click)="toggleArchive(proj, true)"
                  color="warning"
                >
                  <ion-icon name="archive" slot="icon-only"></ion-icon>
                </ion-button>
              </div>
            </ion-item>
          </ion-list>
        </div>
      </div>

      <!-- Normal List View -->
      <ion-list
        *ngIf="!groupByCategory && (filteredProjects$ | async) && (filteredProjects$ | async)!.length > 0"
        lines="none"
      >
        <ion-item
          *ngFor="let proj of (filteredProjects$ | async); trackBy: trackById"
          class="project-item active-project"
          [class.selected]="selectedProjects.has(proj.id)"
        >
          <!-- Selection Checkbox -->
          <ion-checkbox
            *ngIf="(isGroupAdmin$ | async)"
            slot="start"
            [checked]="selectedProjects.has(proj.id)"
            (ionChange)="toggleProjectSelection(proj.id)"
            class="project-checkbox"
          ></ion-checkbox>

          <ion-icon
            *ngIf="!(isGroupAdmin$ | async)"
            name="radio-button-on"
            slot="start"
            color="success"
          ></ion-icon>

          <div class="project-content">
            <ng-container *ngIf="(isGroupAdmin$ | async); else viewProject">
              <ion-input
                [value]="proj.name"
                (ionChange)="updateProject(proj, $event.detail.value)"
                class="project-name-input"
              ></ion-input>
            </ng-container>

            <ng-template #viewProject>
              <div class="project-details">
                <ion-label class="project-name">{{ proj.name }}</ion-label>
                <ion-chip
                  *ngIf="proj.standardCategory && projectCategories[proj.standardCategory]"
                  [style.background-color]="projectCategories[proj.standardCategory].color"
                  class="project-category-badge"
                >
                  <ion-icon
                    [name]="projectCategories[proj.standardCategory].icon"
                    class="category-icon"
                  ></ion-icon>
                  <ion-label>{{ proj.standardCategory }}</ion-label>
                </ion-chip>
              </div>
            </ng-template>
          </div>

          <div
            slot="end"
            class="project-actions"
            *ngIf="(isGroupAdmin$ | async)"
          >
            <ion-button
              fill="clear"
              size="small"
              (click)="toggleArchive(proj, true)"
              color="warning"
            >
              <ion-icon name="archive" slot="icon-only"></ion-icon>
            </ion-button>
          </div>
        </ion-item>
      </ion-list>
    </ion-card-content>
  </ion-card>

  <!-- Archived Projects Section -->
  <div
    *ngIf="(archivedProjects$ | async) && (archivedProjects$ | async)!.length > 0"
    class="archived-section"
  >
    <ion-card class="archived-projects-card">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="archive" class="title-icon"></ion-icon>
          Archived Projects
          <ion-badge color="medium" class="count-badge">
            {{ (archivedProjects$ | async)?.length }}
          </ion-badge>
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list lines="none">
          <ion-item
            *ngFor="let proj of (archivedProjects$ | async); trackBy: trackById"
            class="project-item archived-project"
          >
            <ion-icon name="archive" slot="start" color="medium"></ion-icon>

            <div class="project-content">
              <ion-label class="project-name">
                {{ proj.name }}
                <ion-badge color="medium" class="archived-badge"
                  >Archived</ion-badge
                >
              </ion-label>
            </div>

            <div
              slot="end"
              class="project-actions"
              *ngIf="(isGroupAdmin$ | async)"
            >
              <ion-button
                fill="clear"
                size="small"
                (click)="toggleArchive(proj, false)"
                color="primary"
              >
                <ion-icon name="arrow-undo" slot="icon-only"></ion-icon>
              </ion-button>
            </div>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>
  </div>
</ion-content>
