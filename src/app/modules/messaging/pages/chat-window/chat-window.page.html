<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button
        (click)="goBack()"
        defaultHref="/messaging/chats"
      ></ion-back-button>
    </ion-buttons>

    <ion-title>{{ getChatDisplayName(chat$ | async) }}</ion-title>

    <ion-buttons slot="end">
      <ion-button (click)="showChatOptions()" fill="clear">
        <ion-icon name="ellipsis-vertical" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="chat-content">
  <!-- Messages List -->
  <div class="messages-container">
    <div
      *ngFor="let message of messages; trackBy: trackByMessageId"
      class="message-wrapper"
      [class.own-message]="isOwnMessage(message)"
      [class.other-message]="!isOwnMessage(message)"
    >
      <!-- Message Bubble -->
      <div class="message-bubble">
        <!-- Sender name (for group chats and incoming messages) -->
        <div *ngIf="!isOwnMessage(message)" class="sender-name">
          {{ getSenderName(message) }}
        </div>

        <!-- Message Content -->
        <div class="message-content">
          <!-- Text Message -->
          <div *ngIf="message.type === 'text'" class="text-message">
            {{ message.text }}
          </div>

          <!-- Image Message -->
          <div *ngIf="message.type === 'image'" class="image-message">
            <img
              [src]="message.fileUrl"
              [alt]="message.fileName"
              (click)="openImagePreview(message.fileUrl!)"
            />
          </div>

          <!-- File Message -->
          <div
            *ngIf="message.type === 'file' || message.type === 'video' || message.type === 'audio'"
            class="file-message"
          >
            <ion-icon name="document-outline"></ion-icon>
            <div class="file-info">
              <div
                class="file-name clickable-file-name"
                (click)="openFileInNewWindow(message.fileUrl!, message.fileName!)"
                title="Click to open file in new window"
              >
                {{ message.fileName }}
              </div>
              <div class="file-size">
                {{ formatFileSize(message.fileSize) }}
              </div>
            </div>
            <ion-button
              fill="clear"
              size="small"
              (click)="downloadFile(message.fileUrl!, message.fileName!)"
              title="Download file"
            >
              <ion-icon name="download-outline" slot="icon-only"></ion-icon>
            </ion-button>
          </div>
        </div>

        <!-- Message Timestamp and Status -->
        <div class="message-time">
          {{ formatMessageTime(message.timestamp) }}

          <!-- Message Status (for own messages) -->
          <span *ngIf="isOwnMessage(message)" class="message-status">
            <ion-icon
              *ngIf="message.status === 'sending'"
              name="time-outline"
              class="status-sending"
            >
            </ion-icon>
            <ion-icon
              *ngIf="message.status === 'sent'"
              name="checkmark-outline"
              class="status-sent"
            >
            </ion-icon>
            <ion-icon
              *ngIf="message.status === 'delivered'"
              name="checkmark-done-outline"
              class="status-delivered"
            >
            </ion-icon>
            <ion-icon
              *ngIf="message.status === 'read'"
              name="checkmark-done-outline"
              class="status-read"
            >
            </ion-icon>
            <ion-icon
              *ngIf="message.status === 'failed'"
              name="warning-outline"
              class="status-failed"
            >
            </ion-icon>
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading indicator -->
  <div *ngIf="isLoading" class="loading-message">
    <ion-spinner name="dots"></ion-spinner>
    <span>Sending...</span>
  </div>
</ion-content>

<!-- Blocked Contact Notice -->
<div *ngIf="isContactBlocked" class="blocked-notice">
  <ion-icon name="ban-outline"></ion-icon>
  <span>You have blocked this contact. Messages are disabled.</span>
</div>

<!-- Can't Send Messages Notice -->
<div *ngIf="!canSendMessages && !isContactBlocked" class="blocked-notice">
  <ion-icon name="warning-outline"></ion-icon>
  <span>You can only message accepted friends.</span>
</div>

<!-- Message Input Footer -->
<ion-footer class="message-input-footer" *ngIf="canSendMessages">
  <ion-toolbar>
    <div style="display: flex; align-items: flex-end; gap: 8px">
      <ion-item fill="outline" class="message-input-item" style="flex: 1">
        <ion-textarea
          #messageInput
          [(ngModel)]="newMessage"
          placeholder="Type a message..."
          rows="1"
          autoGrow="true"
          maxlength="1000"
          (keypress)="onKeyPress($event)"
          [disabled]="isLoading || !canSendMessages"
        >
        </ion-textarea>
      </ion-item>

      <div class="message-input-buttons">
        <ion-button
          class="attach-button"
          fill="clear"
          (click)="showAttachmentOptions()"
          [disabled]="isLoading || !canSendMessages"
        >
          <ion-icon name="attach" slot="icon-only"></ion-icon>
        </ion-button>

        <ion-button
          class="send-button"
          fill="solid"
          (click)="sendMessage()"
          [disabled]="!newMessage.trim() || isLoading || !canSendMessages"
        >
          <ion-icon name="send" slot="icon-only"></ion-icon>
        </ion-button>
      </div>
    </div>
  </ion-toolbar>
</ion-footer>
